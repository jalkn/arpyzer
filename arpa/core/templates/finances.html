{% extends "master.html" %}
{% load static %}
{% load humanize %}

{% block title %}Bienes y Rentas{% endblock %}
{% block navbar_title %}Bienes y Rentas{% endblock %}

{% block navbar_buttons %}
<a href="/" class="btn btn-custom-primary" title="Dashboard">
    <i class="fas fa-chart-pie"></i>
</a>
<a href="{% url 'person_list' %}" class="btn btn-custom-primary" title="Personas">
    <i class="fas fa-users"></i>
</a>
<a href="{% url 'tcs_list' %}" class="btn btn-custom-primary" title="Tarjetas">
    <i class="far fa-credit-card"></i>
</a>
<a href="{% url 'conflict_list' %}" class="btn btn-custom-primary" title="Conflictos">
    <i class="fas fa-balance-scale"></i>
</a>
<a href="{% url 'alerts_list' %}" class="btn btn-custom-primary" title="Alertas">
    <i class="fas fa-bell"></i>
</a>
<a href="{% url 'import' %}" class="btn btn-custom-primary" title="Importar">
    <i class="fas fa-database"></i> 
</a>
<a href="{% url 'export_financial_reports_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-custom-primary" title="Exportar a Excel">
    <i class="fas fa-file-excel"></i>
</a>
<form method="post" action="{% url 'logout' %}" class="d-inline">
    {% csrf_token %}
    <button type="submit" class="btn btn-custom-primary" title="Cerrar sesion">
        <i class="fas fa-sign-out-alt"></i>
    </button>
</form>
{% endblock %}

{% block content %}
<div class="card mb-4 border-0 shadow" style="background-color:rgb(224, 224, 224);">
    <div class="card-body">
        <form method="get" action="." class="row g-3 align-items-start"> {# Changed align-items-center to align-items-start #}

            <div class="d-flex align-items-center mb-3 col-12"> {# Added col-12 #}
                <span class="badge bg-success me-2"> {# Added me-2 for margin #}
                    {{ page_obj.paginator.count }} registros
                </span>
            </div>

            <div id="filter-rows-container" class="col-md-9 row g-3">
                <div class="col-12 d-flex gap-2 justify-content-end mt-3"> 
                    <input type="text"
                        name="q"
                        class="form-control form-control-lg me-2" {# Added me-2 for margin between input and button #}
                        placeholder="Buscar persona..."
                        value="{{ request.GET.q|default:'' }}">
                    <button type="button" class="btn btn-custom-primary btn-lg" id="filter-revisar-btn" title="Filtrar por 'Revisar'" style="color: orange;"><i class="fas fa-check-square"></i></button>
                    <button type="submit" class="btn btn-custom-primary btn-lg"><i class="fas fa-filter"></i></button>
                    <a href="." class="btn btn-custom-primary btn-lg"><i class="fas fa-undo"></i></a>
                </div>
                </div>

                <div class="filter-group-template" style="display: none;">
                    <div class="filter-group row g-3 align-items-center">
                        <div class="col-md-4">
                            <select name="column_X" class="form-select form-select-lg column-select">
                                <option value="">Selecciona Columna</option>
                                <option value="fk_id_periodo">Periodo ID</option>
                                <option value="ano_declaracion">Ejercicio Declaracion</option>
                                <option value="activos">Activos</option>
                                <option value="cant_bienes">Cantidad Bienes</option>
                                <option value="cant_bancos">Cantidad Bancos</option>
                                <option value="cant_cuentas">Cantidad Cuentas</option>
                                <option value="cant_inversiones">Cantidad Inversiones</option>
                                <option value="pasivos">Pasivos</option>
                                <option value="cant_deudas">Cantidad Deudas</option>
                                <option value="patrimonio">Patrimonio</option>
                                <option value="endeudamiento">Endeudamiento</option>
                                <option value="aum_pat_subito">Aumento Patrimonio Subito</option>
                                <option value="activos_var_abs">Activos Var. Absoluta</option>
                                <option value="activos_var_rel">Activos Var. Relativa</option>
                                <option value="pasivos_var_abs">Pasivos Var. Absoluta</option>
                                <option value="pasivos_var_rel">Pasivos Var. Relativa</option>
                                <option value="patrimonio_var_abs">Patrimonio Var. Absoluta</option>
                                <option value="patrimonio_var_rel">Patrimonio Var. Relativa</option>
                                <option value="bienes">Bienes</option>
                                <option value="inversiones">Inversiones</option>
                                <option value="banco_saldo_var_abs">Banco Saldo Var. Absoluta</option>
                                <option value="banco_saldo_var_rel">Banco Saldo Var. Relativa</option>
                                <option value="bienes_var_abs">Bienes Var. Absoluta</option>
                                <option value="bienes_var_rel">Bienes Var. Relativa</option>
                                <option value="inversiones_var_abs">Inversiones Var. Absoluta</option>
                                <option value="inversiones_var_rel">Inversiones Var. Relativa</option>
                                <option value="ingresos">Ingresos</option>
                                <option value="cant_ingresos">Cantidad Ingresos</option>
                                <option value="ingresos_var_abs">Ingresos Var. Absoluta</option>
                                <option value="ingresos_var_rel">Ingresos Var. Relativa</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <select name="operator_X" class="form-select form-select-lg operator-select">
                                <option value="">Selecciona operador</option>
                                <option value=">">Mayor que</option>
                                <option value="<">Menor que</option>
                                <option value="=">Igual a</option>
                                <option value=">=">Mayor o igual</option>
                                <option value="<=">Menor o igual</option>
                                <option value="between">Entre</option>
                                <option value="contains">Contiene</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 value1-container">
                            <input type="text"
                                name="value_X"
                                class="form-control form-control-lg value1-input"
                                placeholder="Valor">
                        </div>

                        <div class="col-md-2 value2-container" style="display: none;">
                            <input type="text"
                                name="value2_X"
                                class="form-control form-control-lg value2-input"
                                placeholder="Segundo Valor">
                        </div>
                        <div class="col-md-1 d-flex gap-2 justify-content-end mt-3"> 
                            <button type="button" class="btn btn-danger remove-filter-btn"><i class="fas fa-minus"></i></button>
                            <button type="button" class="btn btn-custom-primary btn-lg" id="add-filter-btn"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div> 
    </div>
</div>

<div class="card border-0 shadow">
    <div class="card-body p-0">
        <div class="table-responsive table-container">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-fixed-header">
                    <tr>
                        <th data-column-index="0"></th>
                        <th data-column-index="1"></th>
                        <th data-column-index="2"></th>
                        <th data-column-index="3"></th>
                        <th data-column-index="4"></th>
                        <th data-column-index="5"></th>
                        <th data-column-index="6"></th>
                        <th data-column-index="7"></th>
                        <th data-column-index="8"></th> 
                        <th data-column-index="9"></th>
                        <th style="background-color: red; color: white;" data-column-index="10">-50%</th>
                        <th data-column-index="11"></th>
                        <th style="background-color: red; color: white;" data-column-index="12">-50%</th>
                        <th data-column-index="13"></th>
                        <th data-column-index="14"></th>
                        <th style="background-color: red; color: white;" data-column-index="15">-50%</th>
                        <th data-column-index="16"></th>
                        <th data-column-index="17"></th>
                        <th data-column-index="18"></th>
                        <th data-column-index="19"></th>
                        <th data-column-index="20"></th>
                        <th data-column-index="21"></th>
                        <th data-column-index="22"></th>
                        <th data-column-index="23"></th>
                        <th data-column-index="24"></th>
                        <th data-column-index="25"></th>
                        <th data-column-index="26"></th>
                        <th data-column-index="27"></th>
                        <th data-column-index="28"></th>
                        <th data-column-index="29"></th>
                        <th data-column-index="30"></th>
                        <th data-column-index="31"></th>
                        <th data-column-index="32"></th>
                        <th data-column-index="33"></th>
                        <th data-column-index="34"></th>
                        <th class="table-fixed-column" data-column-index="35"></th>
                    </tr>
                    <tr>
                        <th data-column-index="0"></th>
                        <th data-column-index="1"></th>
                        <th data-column-index="2"></th>
                        <th data-column-index="3"></th>
                        <th data-column-index="4"></th>
                        <th data-column-index="5"></th>
                        <th data-column-index="6"></th>
                        <th data-column-index="7"></th>
                        <th data-column-index="8"></th> 
                        <th data-column-index="9"></th>
                        <th style="background-color: green; color: white;" data-column-index="10">-30%</th>
                        <th data-column-index="11"></th>
                        <th style="background-color: green; color: white;" data-column-index="12">-30%</th>
                        <th data-column-index="13"></th>
                        <th data-column-index="14"></th>
                        <th style="background-color: green; color: white;" data-column-index="15">-30%</th>
                        <th data-column-index="16"></th>
                        <th data-column-index="17"></th>
                        <th data-column-index="18"></th>
                        <th data-column-index="19"></th>
                        <th data-column-index="20"></th>
                        <th data-column-index="21"></th>
                        <th data-column-index="22"></th>
                        <th data-column-index="23"></th>
                        <th data-column-index="24"></th>
                        <th data-column-index="25"></th>
                        <th data-column-index="26"></th>
                        <th data-column-index="27"></th>
                        <th data-column-index="28"></th>
                        <th data-column-index="29"></th>
                        <th data-column-index="30"></th>
                        <th data-column-index="31"></th>
                        <th data-column-index="32"></th>
                        <th data-column-index="33"></th>
                        <th data-column-index="34"></th>
                        <th class="table-fixed-column" data-column-index="35"></th>
                    </tr>
                    <tr>
                        <th data-column-index="0"></th>
                        <th data-column-index="1"></th>
                        <th data-column-index="2"></th>
                        <th data-column-index="3">Medio</th>
                        <th data-column-index="4"></th>
                        <th style="background-color: green; " data-column-index="5"></th>
                        <th data-column-index="6"></th>
                        <th style="background-color: green;  color: white;" data-column-index="7">1.5</th>
                        <th style="background-color: green;  color: white;" data-column-index="8">50%</th> 
                        <th data-column-index="9"></th>
                        <th style="background-color: green; color: white;" data-column-index="10">30%</th>
                        <th data-column-index="11"></th>
                        <th style="background-color: green; color: white;" data-column-index="12">30%</th>
                        <th data-column-index="13"></th>
                        <th data-column-index="14"></th>
                        <th style="background-color: green; color: white;" data-column-index="15">30%</th>
                        <th data-column-index="16"></th>
                        <th style="background-color: green; color: white;" data-column-index="17">4</th>
                        <th data-column-index="18"></th>
                        <th data-column-index="19"></th>
                        <th data-column-index="20"></th>
                        <th data-column-index="21"></th>
                        <th data-column-index="22"></th>
                        <th data-column-index="23"></th>
                        <th data-column-index="24"></th>
                        <th style="background-color: green; color: white;" data-column-index="25">4</th>
                        <th data-column-index="26"></th>
                        <th data-column-index="27"></th>
                        <th data-column-index="28"></th>
                        <th data-column-index="29"></th>
                        <th data-column-index="30"></th>
                        <th data-column-index="31"></th>
                        <th data-column-index="32"></th>
                        <th data-column-index="33"></th>
                        <th data-column-index="34"></th>
                        <th class="table-fixed-column" data-column-index="35"></th>
                    </tr>
                    <tr>
                        <th data-column-index="0"></th>
                        <th data-column-index="1"></th>
                        <th data-column-index="2"></th>
                        <th data-column-index="3">Alto</th>
                        <th data-column-index="4"></th>
                        <th style="background-color: red;" data-column-index="5"></th>
                        <th data-column-index="6"></th>
                        <th style="background-color: red; color: white;" data-column-index="7">2</th>
                        <th style="background-color: red; color: white;" data-column-index="8">70%</th> 
                        <th data-column-index="9"></th>
                        <th style="background-color: red; color: white;" data-column-index="10">50%</th>
                        <th data-column-index="11"></th>
                        <th style="background-color: red; color: white;" data-column-index="12">50%</th>
                        <th data-column-index="13"></th>
                        <th data-column-index="14"></th>
                        <th style="background-color: red; color: white;" data-column-index="15">50%</th>
                        <th data-column-index="16"></th>
                        <th style="background-color: red; color: white;" data-column-index="17">6</th>
                        <th data-column-index="18"></th>
                        <th data-column-index="19"></th>
                        <th data-column-index="20"></th>
                        <th data-column-index="21"></th>
                        <th data-column-index="22"></th>
                        <th data-column-index="23"></th>
                        <th data-column-index="24"></th>
                        <th style="background-color: red; color: white;" data-column-index="25">6</th>
                        <th data-column-index="26"></th>
                        <th data-column-index="27"></th>
                        <th data-column-index="28"></th>
                        <th data-column-index="29"></th>
                        <th data-column-index="30"></th>
                        <th data-column-index="31"></th>
                        <th data-column-index="32"></th>
                        <th data-column-index="33"></th>
                        <th data-column-index="34"></th>
                        <th class="table-fixed-column" data-column-index="35"></th>
                    </tr>
                    <tr>
                        <th data-column-index="0">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="0" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__revisar&sort_direction={% if current_order == 'person__revisar' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Revisar
                            </a>
                        </th>
                        <th data-column-index="1">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="1" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__nombre_completo&sort_direction={% if current_order == 'person__nombre_completo' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Nombre
                            </a>
                        </th>
                        <th data-column-index="2">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="2" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__compania&sort_direction={% if current_order == 'person__compania' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Compania
                            </a>
                        </th>
                        <th data-column-index="3">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="3" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__cargo&sort_direction={% if current_order == 'person__cargo' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cargo
                            </a>
                        </th>
                        <th style="color: rgb(0, 0, 0);" data-column-index="4">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="4" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            Comentarios
                        </th>
                        <th data-column-index="5">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="5" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=fk_id_periodo&sort_direction={% if current_order == 'fk_id_periodo' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Periodo
                            </a>
                        </th>
                        <th data-column-index="6">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="6" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=ano_declaracion&sort_direction={% if current_order == 'ano_declaracion' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Ejercicio
                            </a>
                        </th>
                        <th data-column-index="7">
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="7" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=aum_pat_subito&sort_direction={% if current_order == 'aum_pat_subito' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Aum. Pat. Subito
                            </a>
                        </th>
                        
                        <th data-column-index="8"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="8" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=endeudamiento&sort_direction={% if current_order == 'endeudamiento' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                % Endeudamiento
                            </a>
                        </th>
                       
                        <th data-column-index="9"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="9" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=patrimonio&sort_direction={% if current_order == 'patrimonio' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Patrimonio
                            </a>
                        </th>
                        <th data-column-index="10"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="10" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=patrimonio_var_rel&sort_direction={% if current_order == 'patrimonio_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Patrimonio Var. Rel. % 
                            </a>
                        </th>
                        <th data-column-index="11"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="11" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=patrimonio_var_abs&sort_direction={% if current_order == 'patrimonio_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Patrimonio Var. Abs. $
                            </a>
                        </th>
                        <th data-column-index="12"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="12" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=activos&sort_direction={% if current_order == 'activos' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Activos
                            </a>
                        </th>
                        <th data-column-index="13"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="13" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=activos_var_rel&sort_direction={% if current_order == 'activos_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Activos Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="14"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="14" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=activos_var_abs&sort_direction={% if current_order == 'activos_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Activos Var. Abs. $
                            </a>
                        </th>
                        <th data-column-index="15"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="15" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=pasivos&sort_direction={% if current_order == 'pasivos' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Pasivos
                            </a>
                        </th>
                        <th data-column-index="16"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="16" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=pasivos_var_rel&sort_direction={% if current_order == 'pasivos_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Pasivos Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="17"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="17" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=pasivos_var_abs&sort_direction={% if current_order == 'pasivos_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Pasivos Var. Abs. $
                            </a>
                        </th>
                        <th data-column-index="18"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="18" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_deudas&sort_direction={% if current_order == 'cant_deudas' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Deudas
                            </a>
                        </th>
                        <th data-column-index="19"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="19" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=ingresos&sort_direction={% if current_order == 'ingresos' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Ingresos
                            </a>
                        </th>
                        <th data-column-index="20"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="20" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=ingresos_var_rel&sort_direction={% if current_order == 'ingresos_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Ingresos Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="21"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="21" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=ingresos_var_abs&sort_direction={% if current_order == 'ingresos_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Ingresos Var. Abs. $
                            </a>
                        </th>
                        <th data-column-index="22"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="22" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_ingresos&sort_direction={% if current_order == 'cant_ingresos' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Ingresos
                            </a>
                        </th>
                        <th data-column-index="23"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="23" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=banco_saldo&sort_direction={% if current_order == 'banco_saldo' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bancos Saldo
                            </a>
                        </th>
                        <th data-column-index="24"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="24" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=banco_saldo_var_rel&sort_direction={% if current_order == 'banco_saldo_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bancos Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="25"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="25" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=banco_saldo_var_abs&sort_direction={% if current_order == 'banco_saldo_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bancos Var. $
                            </a>
                        </th>
                        <th data-column-index="26"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="26" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_cuentas&sort_direction={% if current_order == 'cant_cuentas' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Cuentas
                            </a>
                        </th>
                        <th data-column-index="27"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="27" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_bancos&sort_direction={% if current_order == 'cant_bancos' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Bancos
                            </a>
                        </th>
                        <th data-column-index="28"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="28" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=bienes&sort_direction={% if current_order == 'bienes' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bienes Valor
                            </a>
                        </th>
                        <th data-column-index="29"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="29" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=bienes_var_rel&sort_direction={% if current_order == 'bienes_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bienes Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="30"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="30" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=bienes_var_abs&sort_direction={% if current_order == 'bienes_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Bienes Var. $
                            </a>
                        </th>
                        <th data-column-index="31"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="31" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_bienes&sort_direction={% if current_order == 'cant_bienes' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Bienes
                            </a>
                        </th>
                        <th data-column-index="32"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="32" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=inversiones&sort_direction={% if current_order == 'inversiones' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Inversiones Valor
                            </a>
                        </th>
                        <th data-column-index="33"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="33" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=inversiones_var_rel&sort_direction={% if current_order == 'inversiones_var_rel' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Inversiones Var. Rel. %
                            </a>
                        </th>
                        <th data-column-index="34"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="34" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=inversiones_var_abs&sort_direction={% if current_order == 'inversiones_var_abs' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Inversiones Var. $
                            </a>
                        </th>
                        <th data-column-index="35"> {# Adjusted index #}
                            <button class="btn btn-sm btn-outline-secondary freeze-column-btn" data-column-index="35" title="Congelar columna">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=cant_inversiones&sort_direction={% if current_order == 'cant_inversiones' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Cant. Inversiones
                            </a>
                        </th>
                        <th class="table-fixed-column" style="color: rgb(0, 0, 0);" data-column-index="36">Ver</th> {# Adjusted index #}
                    </tr>
                </thead>
                <tbody>
                    {% for report in financial_reports %}
                        <tr {% if report.person.revisar %}class="table-warning"{% endif %} data-person-cedula="{{ report.person.cedula }}" data-ano-declaracion="{{ report.ano_declaracion }}">
                            {% if report.person and report.person.cedula %}
                            <td>
                                <a href="#" class="btn-toggle-revisar" data-cedula="{{ report.person.cedula }}" title="{% if report.person.revisar %}Marcado para revisar{% else %}No marcado{% endif %}">
                                    <i class="fas fa-{% if report.person.revisar %}check-square text-warning{% else %}square text-secondary{% endif %}" style="padding-left: 20px;"></i>
                                </a>
                            </td>
                            {% else %}
                            <td>
                                <i class="fas fa-exclamation-triangle text-danger" title="Error: No Cedula"></i>
                            </td>
                            {% endif %}

                            <td>{{ report.person.nombre_completo|default:"" }}</td>
                            <td>{{ report.person.compania|default:"" }}</td>
                            <td>{{ report.person.cargo|default:"" }}</td>
                            <td>{{ report.person.comments|truncatechars:30|default:"" }}</td>
                            <td>{{ report.fk_id_periodo|floatformat:"0"|default:"-" }}</td>
                            <td>{{ report.ano_declaracion|floatformat:"0"|default:"-" }}</td>
                            
                            <td data-field="aum_pat_subito"
                                {% if report.aum_pat_subito >= 2 %}
                                    style="color: red;"
                                {% elif report.aum_pat_subito >= 1.5 and report.aum_pat_subito < 2 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.aum_pat_subito|default:"0" }}
                            </td>
                            
                            <td data-field="endeudamiento"
                                {% if report.endeudamiento and report.endeudamiento > 70 %}
                                    style="color: red;"
                                {% elif report.endeudamiento and report.endeudamiento >= 50 and report.endeudamiento <= 70 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.endeudamiento|floatformat:"2"|default:"0" }}
                            </td>

                            <td data-field="patrimonio">{{ report.patrimonio|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="patrimonio_var_rel"
                                {% if report.patrimonio_var_rel and report.patrimonio_var_rel|floatformat:"0"|add:0 >= 50 or report.patrimonio_var_rel and report.patrimonio_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.patrimonio_var_rel and report.patrimonio_var_rel|floatformat:"0"|add:0 >= 30 and report.patrimonio_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.patrimonio_var_rel and report.patrimonio_var_rel|floatformat:"0"|add:0 > -50 and report.patrimonio_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.patrimonio_var_rel|default:"0" }}
                            </td>

                            <td data-field="patrimonio_var_abs">{{ report.patrimonio_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="activos">{{ report.activos|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="activos_var_rel"
                                {% if report.activos_var_rel and report.activos_var_rel|floatformat:"0"|add:0 >= 50 or report.activos_var_rel and report.activos_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.activos_var_rel and report.activos_var_rel|floatformat:"0"|add:0 >= 30 and report.activos_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.activos_var_rel and report.activos_var_rel|floatformat:"0"|add:0 > -50 and report.activos_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.activos_var_rel|default:"0" }}
                            </td>
                            <td data-field="activos_var_abs">{{ report.activos_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="pasivos">{{ report.pasivos|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="pasivos_var_rel"
                                {% if report.pasivos_var_rel and report.pasivos_var_rel|floatformat:"0"|add:0 >= 50 or report.pasivos_var_rel and report.pasivos_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.pasivos_var_rel and report.pasivos_var_rel|floatformat:"0"|add:0 >= 30 and report.pasivos_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.pasivos_var_rel and report.pasivos_var_rel|floatformat:"0"|add:0 > -50 and report.pasivos_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.pasivos_var_rel|default:"0" }}
                            </td>
                            <td data-field="pasivos_var_abs">{{ report.pasivos_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            
                            <td data-field="cant_deudas"
                                {% if report.cant_deudas >= 6 %}
                                    style="color: red;"
                                {% elif report.cant_deudas >= 4 and report.cant_deudas < 6 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.cant_deudas|floatformat:"0"|intcomma|default:"0" }}
                            </td>

                            <td data-field="ingresos">{{ report.ingresos|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="ingresos_var_rel"
                                {% if report.ingresos_var_rel and report.ingresos_var_rel|floatformat:"0"|add:0 >= 50 or report.ingresos_var_rel and report.ingresos_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.ingresos_var_rel and report.ingresos_var_rel|floatformat:"0"|add:0 >= 30 and report.ingresos_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.ingresos_var_rel and report.ingresos_var_rel|floatformat:"0"|add:0 > -50 and report.ingresos_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.ingresos_var_rel|default:"0" }}
                            </td>
                            <td data-field="ingresos_var_abs">{{ report.ingresos_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="cant_ingresos">{{ report.cant_ingresos|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="banco_saldo">{{ report.banco_saldo|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="banco_saldo_var_rel"
                                {% if report.banco_saldo_var_rel and report.banco_saldo_var_rel|floatformat:"0"|add:0 >= 50 or report.banco_saldo_var_rel and report.banco_saldo_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.banco_saldo_var_rel and report.banco_saldo_var_rel|floatformat:"0"|add:0 >= 30 and report.banco_saldo_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.banco_saldo_var_rel and report.banco_saldo_var_rel|floatformat:"0"|add:0 > -50 and report.banco_saldo_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.banco_saldo_var_rel|default:"0" }}
                            </td>
                            <td data-field="banco_saldo_var_abs">{{ report.banco_saldo_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            
                            <td data-field="cant_cuentas"
                                {% if report.cant_cuentas >= 6 %}
                                    style="color: red;"
                                {% elif report.cant_cuentas >= 4 and report.cant_cuentas < 6 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.cant_cuentas|floatformat:"0"|intcomma|default:"0" }}
                            </td>
                            
                            <td data-field="cant_bancos">{{ report.cant_bancos|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="bienes">{{ report.bienes|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="bienes_var_rel"
                                {% if report.bienes_var_rel and report.bienes_var_rel|floatformat:"0"|add:0 >= 50 or report.bienes_var_rel and report.bienes_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.bienes_var_rel and report.bienes_var_rel|floatformat:"0"|add:0 >= 30 and report.bienes_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.bienes_var_rel and report.bienes_var_rel|floatformat:"0"|add:0 > -50 and report.bienes_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.bienes_var_rel|default:"0" }}
                            </td>
                            <td data-field="bienes_var_abs">{{ report.bienes_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="cant_bienes">{{ report.cant_bienes|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="inversiones">{{ report.inversiones|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="inversiones_var_rel"
                                {% if report.inversiones_var_rel and report.inversiones_var_rel|floatformat:"0"|add:0 >= 50 or report.inversiones_var_rel and report.inversiones_var_rel|floatformat:"0"|add:0 <= -50 %}
                                    style="color: red;"
                                {% elif report.inversiones_var_rel and report.inversiones_var_rel|floatformat:"0"|add:0 >= 30 and report.inversiones_var_rel|floatformat:"0"|add:0 < 50 %}
                                    style="color: green;"
                                {% elif report.inversiones_var_rel and report.inversiones_var_rel|floatformat:"0"|add:0 > -50 and report.inversiones_var_rel|floatformat:"0"|add:0 <= -30 %}
                                    style="color: green;"
                                {% endif %}>
                                {{ report.inversiones_var_rel|default:"0" }}
                            </td>
                            <td data-field="inversiones_var_abs">{{ report.inversiones_var_abs|floatformat:"0"|intcomma|default:"0" }}</td>
                            <td data-field="cant_inversiones">{{ report.cant_inversiones|floatformat:"0"|intcomma|default:"0" }}</td>
                            
                            <td class="table-fixed-column">
                                {% if report.person and report.person.cedula %}
                                    <a href="{% url 'person_details' report.person.cedula %}"
                                    class="btn btn-custom-primary btn-sm"
                                    title="View person details">
                                        <i class="bi bi-person-vcard-fill"></i>
                                    </a>
                                {% else %}
                                    <span title="No person details available">&#x2014;</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="37" class="text-center py-4"> {# Adjusted colspan #}
                                {% if request.GET.q or request.GET.column_0 or request.GET.operator_0 or request.GET.value_0 %}
                                    Sin reportes financieros que coincidan con los filtros.
                                {% else %}
                                    Sin reportes financieros
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if page_obj.has_other_pages %}
        <div class="p-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        // Find all the buttons inside the 'revisar-form' forms
        const revisarButtons = document.querySelectorAll('.revisar-form button[type="submit"]');

        revisarButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                // Prevent the default form submission and any parent click handlers
                event.preventDefault();
                event.stopPropagation();

                // Find the closest parent form and submit it programmatically
                const form = this.closest('form');
                if (form) {
                    form.submit();
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-toggle-revisar').forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                const cedula = this.getAttribute('data-cedula');
                if (cedula) {
                    const form = document.createElement('form');
                    form.action = "{% url 'toggle_revisar_status' 'placeholder' %}".replace('placeholder', cedula);
                    form.method = 'POST';
                    
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    const csrfInput = document.createElement('input');
                    csrfInput.type = 'hidden';
                    csrfInput.name = 'csrfmiddlewaretoken';
                    csrfInput.value = csrfToken;
                    form.appendChild(csrfInput);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            });
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
        // Find all the buttons inside the 'revisar-form' forms
        const revisarButtons = document.querySelectorAll('.revisar-form button[type="submit"]');

        revisarButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                // Prevent the default form submission and any parent click handlers
                event.preventDefault();
                event.stopPropagation();

                // Find the closest parent form and submit it programmatically
                const form = this.closest('form');
                if (form) {
                    form.submit();
                }
            });
        });
    });


    let filterCount = 0; // Global counter for filter groups

    // Function to show/hide value2 input based on operator
    function toggleValueInput(selectElement) {
        const filterGroup = selectElement.closest('.filter-group');
        const value1Container = filterGroup.querySelector('.value1-container');
        const value1Input = filterGroup.querySelector('.value1-input');
        const value2Container = filterGroup.querySelector('.value2-container');
        const operatorSelect = selectElement;

        if (operatorSelect.value === 'between') {
            value2Container.style.display = 'block';
            value1Input.placeholder = "Primer Valor";
            value1Container.classList.remove('col-md-3');
            value1Container.classList.add('col-md-2');
        } else {
            value2Container.style.display = 'none';
            value2Container.querySelector('.value2-input').value = ''; // Clear value2 when hidden
            value1Input.placeholder = "Valor";
            value1Container.classList.remove('col-md-2');
            value1Container.classList.add('col-md-3');
        }
    }

    // Function to add a new filter group
    function addFilterGroup(initialValues = {}) {
        const filterContainer = document.getElementById('filter-rows-container');
        const template = document.querySelector('.filter-group-template .filter-group');
        const newFilterGroup = template.cloneNode(true);
        newFilterGroup.style.display = 'flex'; // Make the cloned element visible

        const currentIndex = filterCount++;

        newFilterGroup.querySelectorAll('select, input').forEach(input => {
            const oldName = input.name;
            // Replace '_X' placeholder with actual index
            input.name = oldName.replace('_X', '_' + currentIndex);
            input.id = input.name; // Assign an ID based on the name

            // Set initial values if provided
            if (initialValues[input.name]) {
                input.value = initialValues[input.name];
            } else {
                input.value = ''; // Clear values for newly added empty filters
            }

            // Reset placeholder for value1 inputs
            if (input.classList.contains('value1-input')) {
                input.placeholder = "Valor";
            }
        });

        // Set up event listeners for the new filter group
        const newOperatorSelect = newFilterGroup.querySelector('.operator-select');
        newOperatorSelect.onchange = function() { toggleValueInput(this); };

        const removeButton = newFilterGroup.querySelector('.remove-filter-btn');
        removeButton.onclick = function() {
            newFilterGroup.remove();
        };

        filterContainer.appendChild(newFilterGroup);

        // Apply toggleValueInput logic based on the operator's initial value (if loaded from GET)
        toggleValueInput(newOperatorSelect);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        let hasFilters = false;

        // This loop checks for the existence of 'column_i' or 'value_i' to determine if a filter was applied.
        let tempFilterIndex = 0;
        while (urlParams.has('column_' + tempFilterIndex) ||
               urlParams.has('operator_' + tempFilterIndex) ||
               urlParams.has('value_' + tempFilterIndex) ||
               urlParams.has('value2_' + tempFilterIndex)) {

            const initialValues = {};
            initialValues['column_' + tempFilterIndex] = urlParams.get('column_' + tempFilterIndex);
            initialValues['operator_' + tempFilterIndex] = urlParams.get('operator_' + tempFilterIndex);
            initialValues['value_' + tempFilterIndex] = urlParams.get('value_' + tempFilterIndex);
            initialValues['value2_' + tempFilterIndex] = urlParams.get('value2_' + tempFilterIndex);

            addFilterGroup(initialValues);
            hasFilters = true;
            tempFilterIndex++;
        }

        // If no filters were present in the URL, add one blank filter group
        if (!hasFilters) {
            addFilterGroup();
        }

        // Add event listener for the 'Add Filter' button
        const addFilterButton = document.getElementById('add-filter-btn');
        if (addFilterButton) {
            addFilterButton.addEventListener('click', function() {
                addFilterGroup({});
            });
        }

        // --- MODIFIED JAVASCRIPT FOR "Revisar" FILTER BUTTON AND CLIENT-SIDE FILTERING ---
        const filterRevisarButton = document.getElementById('filter-revisar-btn');
        if (filterRevisarButton) {
            filterRevisarButton.addEventListener('click', function() {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('q'); // Clear any existing search query
                currentUrl.searchParams.delete('page'); // Reset pagination

                // Clear all existing dynamic filters
                let i = 0;
                while (currentUrl.searchParams.has('column_' + i) ||
                       currentUrl.searchParams.has('operator_' + i) ||
                       currentUrl.searchParams.has('value_' + i) ||
                       currentUrl.searchParams.has('value2_' + i)) {
                    currentUrl.searchParams.delete('column_' + i);
                    currentUrl.searchParams.delete('operator_' + i);
                    currentUrl.searchParams.delete('value_' + i);
                    currentUrl.searchParams.delete('value2_' + i);
                    i++;
                }

                // Toggle the "revisar" filter
                if (currentUrl.searchParams.get('revisar') === 'True') {
                    currentUrl.searchParams.delete('revisar');
                } else {
                    currentUrl.searchParams.set('revisar', 'True');
                }

                window.location.href = currentUrl.toString();
            });
        }

        // Client-side filtering if 'revisar=True' is in the URL
        if (urlParams.get('revisar') === 'True') {
            const tableRows = document.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                // Check if the row has the 'table-warning' class which indicates 'revisar' status
                if (!row.classList.contains('table-warning')) {
                    row.style.display = 'none'; // Hide rows that are not marked for review
                }
            });

            // Adjust the records count badge
            const recordCountBadge = document.querySelector('.badge.bg-success');
            if (recordCountBadge) {
                let visibleRows = 0;
                document.querySelectorAll('tbody tr').forEach(row => {
                    if (row.style.display !== 'none') {
                        visibleRows++;
                    }
                });
                recordCountBadge.textContent = visibleRows + ' registros';
            }

            // Hide pagination if only 'revisar' rows are shown and there might be no more pages
            const paginationDiv = document.querySelector('.p-3');
            if (paginationDiv) {
                // You might need more sophisticated logic here based on your Django pagination.
                // For simplicity, we'll hide it if we're filtering client-side.
                paginationDiv.style.display = 'none';
            }
        }
        // --- END OF MODIFIED JAVASCRIPT ---
    });
</script>

</div>
{% endblock %}
