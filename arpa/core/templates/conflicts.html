{% extends "master.html" %}
{% load static %}

{% block title %}Conflictos{% endblock %}
{% block navbar_title %}Conflictos{% endblock %}

{% block navbar_buttons %}
<a href="/" class="btn btn-custom-primary" title="Dashboard">
    <i class="fas fa-chart-pie"></i>
</a>
<a href="{% url 'person_list' %}" class="btn btn-custom-primary" title="Personas">
    <i class="fas fa-users"></i>
</a>
<a href="{% url 'financial_report_list' %}" class="btn btn-custom-primary" title="Bienes y Rentas">
    <i class="fas fa-chart-line"></i>
</a>
<a href="{% url 'tcs_list' %}" class="btn btn-custom-primary" title="Tarjetas">
    <i class="far fa-credit-card"></i>
</a>
<a href="{% url 'alerts_list' %}" class="btn btn-custom-primary" title="Alertas">
    <i class="fas fa-bell"></i>
</a>
<a href="{% url 'import' %}" class="btn btn-custom-primary" title="Importar">
    <i class="fas fa-database"></i> 
</a>
<a href="{% url 'export_persons_excel' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-custom-primary" title="Exportar a Excel">
    <i class="fas fa-file-excel"></i>
</a>
<form method="post" action="{% url 'logout' %}" class="d-inline">
    {% csrf_token %}
    <button type="submit" class="btn btn-custom-primary" title="Cerrar sesion">
        <i class="fas fa-sign-out-alt"></i>
    </button>
</form>
{% endblock %}

{% block content %}
<div class="card mb-4 border-0 shadow" style="background-color:rgb(224, 224, 224);">
    <div class="card-body">
        <form method="get" action="." class="row g-3 align-items-center no-loading">
            <div class="d-flex align-items-center mb-3"> {# Added mb-3 for spacing #}
                <span class="badge bg-success me-2"> {# Added me-2 for spacing #}
                    {{ page_obj.paginator.count }} registros
                </span>
                {% if request.GET.q or request.GET.compania or request.GET.column or request.GET.answer %}
                {% endif %}
            </div>

            <div class="col-md-4">
                <input type="text"
                       name="q"
                       class="form-control form-control-lg"
                       placeholder="Buscar Persona..."
                       {% if request.GET.q %}autofocus{% endif %}
                       value="{{ request.GET.q }}">
            </div>

            <div class="col-md-2">
                <select name="column" class="form-select form-select-lg">
                    <option value="">Selecciona Pregunta</option>
                    <option value="q1" {% if request.GET.column == 'q1' %}selected{% endif %}>Accionista de proveedor</option>
                    <option value="q2" {% if request.GET.column == 'q2' %}selected{% endif %}>Familiar de accionista/empleado</option>
                    <option value="q3" {% if request.GET.column == 'q3' %}selected{% endif %}>Accionista del grupo</option>
                    <option value="q4" {% if request.GET.column == 'q4' %}selected{% endif %}>Actividades extralaborales</option>
                    <option value="q5" {% if request.GET.column == 'q5' %}selected{% endif %}>Negocios con empleados</option>
                    <option value="q6" {% if request.GET.column == 'q6' %}selected{% endif %}>Participacion en juntas</option>
                    <option value="q7" {% if request.GET.column == 'q7' %}selected{% endif %}>Otro conflicto</option>
                    <option value="q8" {% if request.GET.column == 'q8' %}selected{% endif %}>Conoce codigo de conducta</option>
                    <option value="q9" {% if request.GET.column == 'q9' %}selected{% endif %}>Veracidad de informacion</option>
                    <option value="q10" {% if request.GET.column == 'q10' %}selected{% endif %}>Familiar de funcionario</option>
                    <option value="q11" {% if request.GET.column == 'q11' %}selected{% endif %}>Relacion con sector publico</option>
                </select>
            </div>

            <div class="col-md-2">
                <select name="answer" class="form-select form-select-lg">
                    <option value="">Selecciona Respuesta</option>
                    <option value="yes" {% if request.GET.answer == 'yes' %}selected{% endif %}>Si</option>
                    <option value="no" {% if request.GET.answer == 'no' %}selected{% endif %}>No</option>
                    <option value="blank" {% if request.GET.answer == 'blank' %}selected{% endif %}>En Blanco</option> {# Added this line #}
                </select>
            </div>

            <div class="col-md-2 d-flex gap-2">
                <button type="button" class="btn btn-custom-primary flex-grow-1" id="filter-revisar-btn-conflicts" title="Filtrar por 'Revisar'" style="color: orange;"><i class="fas fa-check-square"></i></button>
                <button type="submit" class="btn btn-custom-primary btn-lg flex-grow-1"><i class="fas fa-filter"></i></button>
                <a href="." class="btn btn-custom-primary btn-lg flex-grow-1"><i class="fas fa-undo"></i></a>
            </div>
        </form>
    </div>
</div>

<div class="card border-0 shadow">
    <div class="card-body p-0">
        <div class="table-responsive table-container">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-fixed-header">
                    <tr>
                        <th>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__revisar&sort_direction={% if current_order == 'person__revisar' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Revisar
                            </a>
                        </th>
                        <th>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__nombre_completo&sort_direction={% if current_order == 'person__nombre_completo' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Nombre
                            </a>
                        </th>
                        <th>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=person__compania&sort_direction={% if current_order == 'person__compania' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Compania
                            </a>
                        </th>
                        <th>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=fecha_inicio&sort_direction={% if current_order == 'fecha_inicio' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Ejercicio
                            </a>
                        </th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q1" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q1&sort_direction={% if current_order == 'q1' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Accionista de proveedor
                            </a>
                        </th>
                        <th class="answer-q1 hidden-answer">Detalle Q1</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q2" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q2&sort_direction={% if current_order == 'q2' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Familiar de accionista/empleado
                            </a>
                        </th>
                        <th class="answer-q2 hidden-answer">Detalle Q2</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q3" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q3&sort_direction={% if current_order == 'q3' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Accionista del grupo
                            </a>
                        </th>
                        <th class="answer-q3 hidden-answer">Detalle Q3</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q4" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q4&sort_direction={% if current_order == 'q4' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Actividades extralaborales
                            </a>
                        </th>
                        <th class="answer-q4 hidden-answer">Detalle Q4</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q5" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q5&sort_direction={% if current_order == 'q5' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Negocios con empleados
                            </a>
                        </th>
                        <th class="answer-q5 hidden-answer">Detalle Q5</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q6" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q6&sort_direction={% if current_order == 'q6' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Participacion en juntas
                            </a>
                        </th>
                        <th class="answer-q6 hidden-answer">Detalle Q6</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q7" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q7&sort_direction={% if current_order == 'q7' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Otro conflicto
                            </a>
                        </th>
                        <th class="answer-q7 hidden-answer">Detalle Q7</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q8" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q8&sort_direction={% if current_order == 'q8' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Conoce codigo de conducta
                            </a>
                        </th>
                        <th class="answer-q8 hidden-answer">Detalle Q8</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q9" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q9&sort_direction={% if current_order == 'q9' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Veracidad de informacion
                            </a>
                        </th>
                        <th class="answer-q9 hidden-answer">Detalle Q9</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q10" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q10&sort_direction={% if current_order == 'q10' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Familiar de funcionario
                            </a>
                        </th>
                        <th class="answer-q10 hidden-answer">Detalle Q10</th>
                        <th>
                            <i class="fas fa-eye answer-toggle-icon" data-column="answer-q11" style="cursor: pointer;"></i>
                            <a href="?{% for key, value in all_params.items %}{{ key }}={{ value }}&{% endfor %}order_by=q11&sort_direction={% if current_order == 'q11' and current_direction == 'asc' %}desc{% else %}asc{% endif %}" style="text-decoration: none; color: rgb(0, 0, 0);">
                                Relacion con sector publico
                            </a>
                        </th>
                        <th class="answer-q11 hidden-answer">Detalle Q11</th>
                        <th style="color: rgb(0, 0, 0);">Comentarios</th>
                        <th class="table-fixed-column" style="color: rgb(0, 0, 0);">Ver</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conflict in conflicts %}
                        <tr {% if conflict.person.revisar %}class="table-warning"{% endif %}>
                            <td>
                                <form action="{% url 'toggle_revisar_status' conflict.person.cedula %}" method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer;" title="{% if conflict.person.revisar %}Marcado para revisar{% else %}No marcado{% endif %}">
                                        <i class="fas fa-{% if conflict.person.revisar %}check-square text-warning{% else %}square text-secondary{% endif %}" style="padding-left: 20px;"></i>
                                    </button>
                                </form>
                            </td>
                            <td>{{ conflict.person.nombre_completo }}</td>
                            <td>{{ conflict.person.compania }}</td>
                            <td>{% if conflict.fecha_inicio %}{{ conflict.fecha_inicio.year }}{% else %}N/A{% endif %}</td> {# Displaying the year #}
                            <td class="text-center">{% if conflict.q1 %}<i style="color: red;">SI</i>{% elif conflict.q1 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q1 hidden-answer">{{ conflict.q1_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q2 %}<i style="color: red;">SI</i>{% elif conflict.q2 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q2 hidden-answer">{{ conflict.q2_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q3 %}<i style="color: red;">SI</i>{% elif conflict.q3 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q3 hidden-answer">{{ conflict.q3_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q4 %}<i style="color: red;">SI</i>{% elif conflict.q4 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q4 hidden-answer">{{ conflict.q4_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q5 %}<i style="color: red;">SI</i>{% elif conflict.q5 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q5 hidden-answer">{{ conflict.q5_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q6 %}<i style="color: red;">SI</i>{% elif conflict.q6 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q6 hidden-answer">{{ conflict.q6_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q7 %}<i style="color: red;">SI</i>{% elif conflict.q7 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q7 hidden-answer">{{ conflict.q7_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q8 %}<i style="color: green;">SI</i>{% elif conflict.q8 is False %}<i style="color: red;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q8 hidden-answer">{{ conflict.q8_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q9 %}<i style="color: green;">SI</i>{% elif conflict.q9 is False %}<i style="color: RED;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q9 hidden-answer">{{ conflict.q9_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q10 %}<i style="color: red;">SI</i>{% elif conflict.q10 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q10 hidden-answer">{{ conflict.q10_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td class="text-center">{% if conflict.q11 %}<i style="color: red;">SI</i>{% elif conflict.q11 is False %}<i style="color: green;">NO</i>{% else %}N/A{% endif %}</td>
                            <td class="answer-q11 hidden-answer">{{ conflict.q11_answer|default:"N/A" }}</td> {# Hidden answer column #}
                            <td>{{ conflict.person.comments|truncatechars:30|default:"" }}</td>
                            <td class="table-fixed-column">
                                <a href="{% url 'person_details' conflict.person.cedula %}"
                                   class="btn btn-custom-primary btn-sm"
                                   title="View details">
                                    <i class="bi bi-person-vcard-fill"></i>
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="36" class="text-center py-4"> {# Adjusted colspan to match the new number of columns #}
                                {% if missing_details_view %} {# Conditional message for the new view #}
                                    No hay conflictos con detalles faltantes para respuestas "SÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â­".
                                {% elif request.GET.q or request.GET.compania or request.GET.column or request.GET.answer %}
                                    Sin registros que coincidan con los filtros.
                                {% else %}
                                    Sin registros de conflictos
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
        <div class="p-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Existing JavaScript for Answer Toggling ---
        const answerToggleIcons = document.querySelectorAll('.answer-toggle-icon');

        // Initial state: hide all answer columns and show the info icons
        document.querySelectorAll('.hidden-answer').forEach(cell => {
            cell.style.display = 'none';
        });
        answerToggleIcons.forEach(icon => {
            icon.style.display = 'inline-block'; // Ensure icons are visible
        });

        // Event listener for each individual info icon
        answerToggleIcons.forEach(icon => {
            icon.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent column sort if clicked on icon
                const columnClass = this.dataset.column; // e.g., "answer-q1"

                // Toggle visibility of all cells (<th> and <td>) with this class
                document.querySelectorAll(`.${columnClass}`).forEach(cell => {
                    if (cell.style.display === 'none' || cell.style.display === '') {
                        cell.style.display = 'table-cell';
                    } else {
                        cell.style.display = 'none';
                    }
                });
            });
        });

        // --- NEW JavaScript for "Revisar" Filtering (Merged) ---
        const urlParams = new URLSearchParams(window.location.search);

        // Event Listener for "Revisar" Filter Button for Conflicts
        const filterRevisarButtonConflicts = document.getElementById('filter-revisar-btn-conflicts');
        if (filterRevisarButtonConflicts) {
            filterRevisarButtonConflicts.addEventListener('click', function() {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('q'); // Clear any general search query
                currentUrl.searchParams.delete('page'); // Reset pagination

                // Toggle the "revisar" filter parameter
                if (currentUrl.searchParams.get('revisar') === 'True') {
                    currentUrl.searchParams.delete('revisar');
                } else {
                    currentUrl.searchParams.set('revisar', 'True');
                }

                window.location.href = currentUrl.toString();
            });
        }

        // Client-side Filtering Logic (hide non-marked rows) for Conflicts Table
        if (urlParams.get('revisar') === 'True') {
            const tableRows = document.querySelectorAll('tbody tr'); // Assuming your conflicts table rows are within <tbody>
            tableRows.forEach(row => {
                // Check if the row has the 'table-warning' class which indicates 'revisar' status
                if (!row.classList.contains('table-warning')) {
                    row.style.display = 'none'; // Hide rows that are not marked for review
                }
            });

            // Optionally, update the records count badge (adjust selector if different for conflicts)
            const recordCountBadge = document.querySelector('.badge.bg-success');
            if (recordCountBadge) {
                let visibleRows = 0;
                document.querySelectorAll('tbody tr').forEach(row => {
                    if (row.style.display !== 'none') {
                        visibleRows++;
                    }
                });
                recordCountBadge.textContent = visibleRows + ' registros';
            }

            // Optionally, hide pagination if filtering client-side
            const paginationDiv = document.querySelector('.p-3'); // Adjust selector if different
            if (paginationDiv) {
                paginationDiv.style.display = 'none';
            }
        }

        // Update Excel Export Button Link for Conflicts
        const exportExcelButtonConflicts = document.getElementById('export-conflicts-excel-button'); // Assumed ID for the conflicts export button
        if (exportExcelButtonConflicts) {
            const originalHref = exportExcelButtonConflicts.href; // Store the original href

            const exportUrl = new URL(originalHref);

            if (urlParams.get('revisar') === 'True') {
                exportUrl.searchParams.set('revisar', 'True');
            } else {
                exportUrl.searchParams.delete('revisar');
            }
            exportExcelButtonConflicts.href = exportUrl.toString(); // Update the export button's href
        }
    });
</script>
{% endblock %}
